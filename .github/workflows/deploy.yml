name: üöÄ Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # JOB 1: Tests et Build
  # ============================================
  build:
    name: üî® Build Application
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip, bcmath
          coverage: none

      - name: üì¶ Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: üíæ Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: üì• Install Composer dependencies
        run: composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install NPM dependencies
        run: npm ci

      - name: üî® Build assets
        run: npm run build

      - name: üì§ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            vendor/
            public/build/
            bootstrap/cache/
          retention-days: 1

  # ============================================
  # JOB 2: D√©ploiement
  # ============================================
  deploy:
    name: üöÄ Deploy to VPS
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì• Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: üîë Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: üìÖ Generate release name
        id: release
        run: echo "name=$(date +'%Y%m%d_%H%M%S')_${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: üì§ Deploy to server
        run: |
          # Cr√©er le dossier de release
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "mkdir -p ${{ secrets.VPS_PATH }}/releases/${{ steps.release.outputs.name }}"

          # Synchroniser les fichiers
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.env' \
            --exclude='storage' \
            --exclude='DEPLOYMENT.md' \
            -e "ssh -i ~/.ssh/deploy_key" \
            ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_PATH }}/releases/${{ steps.release.outputs.name }}/

      - name: üîó Activate release
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e

            RELEASE_PATH="${{ secrets.VPS_PATH }}/releases/${{ steps.release.outputs.name }}"
            SHARED_PATH="${{ secrets.VPS_PATH }}/shared"
            CURRENT_PATH="${{ secrets.VPS_PATH }}/current"

            echo "üîó Linking shared files..."
            # Lier .env
            ln -sfn ${SHARED_PATH}/.env ${RELEASE_PATH}/.env

            # Lier storage
            rm -rf ${RELEASE_PATH}/storage
            ln -sfn ${SHARED_PATH}/storage ${RELEASE_PATH}/storage

            echo "üì¶ Running Laravel optimizations..."
            cd ${RELEASE_PATH}

            # V√©rifier la connexion √† la base de donn√©es
            echo "üîå Checking database connection..."
            php artisan db:show --counts || echo "‚ö†Ô∏è Could not connect to database"

            # Migrations avec affichage d√©taill√©
            echo "üóÑÔ∏è Running migrations..."
            php artisan migrate --force --verbose

            # Executer les seeders si n√©cessaire
            # echo "üå± Seeding database..."
            php artisan db:seed --class=RolesAndPermissionsSeeder
            php artisan users:sync-roles

            # Afficher le statut des migrations
            echo "üìã Migration status:"
            php artisan migrate:status | tail -20

            # Cache
            echo "‚ö° Caching configuration..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan event:cache

            # Storage link
            php artisan storage:link --force 2>/dev/null || true

            # Publish Livewire assets
            php artisan livewire:publish --assets 2>/dev/null || true

            echo "üîÑ Switching to new release..."
            ln -sfn ${RELEASE_PATH} ${CURRENT_PATH}

            echo "üîÑ Reloading PHP-FPM..."
            # Try different methods to reload PHP-FPM
            if command -v sudo &> /dev/null; then
              sudo /bin/systemctl reload php8.2-fpm || true
            elif [ -f /var/run/php/php8.2-fpm.pid ]; then
              kill -USR2 $(cat /var/run/php/php8.2-fpm.pid) 2>/dev/null || true
            else
              echo "‚ö†Ô∏è Could not reload PHP-FPM automatically. Please reload manually if needed."
            fi

            echo "üßπ Cleaning old releases (keeping last 5)..."
            cd ${{ secrets.VPS_PATH }}/releases
            ls -t | tail -n +6 | xargs -r rm -rf


            echo "‚úÖ Deployment completed successfully!"
          ENDSSH

      - name: ‚úÖ Deployment notification
        if: success()
        run: |
          echo "üéâ Deployment successful!"
          echo "Release: ${{ steps.release.outputs.name }}"
          echo "URL: https://etsgobel.com"

      - name: ‚ùå Rollback on failure
        if: failure()
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            echo "‚ö†Ô∏è Deployment failed, checking for rollback..."
            RELEASES_PATH="${{ secrets.VPS_PATH }}/releases"
            CURRENT_PATH="${{ secrets.VPS_PATH }}/current"

            # Trouver la release pr√©c√©dente
            PREVIOUS_RELEASE=$(ls -t ${RELEASES_PATH} | sed -n '2p')

            if [ -n "$PREVIOUS_RELEASE" ]; then
              echo "üîô Rolling back to ${PREVIOUS_RELEASE}..."
              ln -sfn ${RELEASES_PATH}/${PREVIOUS_RELEASE} ${CURRENT_PATH}
              echo "‚úÖ Rollback completed"
            else
              echo "‚ö†Ô∏è No previous release found for rollback"
            fi
          ENDSSH

